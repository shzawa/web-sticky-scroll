<task>
タスクを再開してください
</task>

<answer>
最初の指示は以下の通りです。

# ブラウザ拡張作成のお願い

## あなたの想定人物像

あなたはフロントエンド開発歴が10年以上のエキスパート級エンジニアです。

## 今回作ってほしいもの

私はVSCodeの機能である StickyScroll が大好きです。それをブラウザで動かしたいです。

## 仕様要件

あなたにはStickyScrollををブラウザ上で実現するための拡張機能を作ってもらいます。
その拡張機能は特にNotionでの利用を想定しています。
上記のVSCodeでのStickyScrollはコードブロックを計算対象としていますが、
今回作ってもらう拡張機能ではブラウザ上での表現になるためh1~h6タグの見出し要素を計算対象としてください。

また、このブラウザ拡張が動作するページのURLパターンはユーザーが自由に登録できるようにしてほしいです。
それを登録できるようオプション機能を設けてください。

## 技術要件

ブラウザ拡張を作るにあたり、利用してもらいたい技術スタックは以下の通りです。

- WXT: ブラウザ拡張作成用のフレームワーク
- TypeScript
- React
- Tailwind CSS
- shadcn/ui

## 具体的な仕様

Sticky Scrollの挙動を GPT-4o が説明してくれました。以下を満たすよう実装してください

### GPT-4o の説明

VSCodeのSticky Scroll機能をブラウザ内で再現するための要件について考えてみましょう。Sticky Scrollは一般に、ページをスクロールしても特定の要素が常に表示される機能です。これをHTMLの`h1`から`h6`タグに適用するには、次の要件が考えられます。

1. **位置とスタイルの固定**:
   - スクロール時に、現在のビューポート内で最も近い上位の見出し（`h1`～`h6`）が画面上部に固定される。
   - 固定された見出しは視認性を保つためにスタイリングが必要（例: 背景色の指定、テキストの色やサイズの調整）。

2. **優先順位の管理**:
   - `h1`～`h6`の優先順位に従い、最も重要な見出しが常に表示されるようにする。
   - 同レベルの見出しが複数ある場合は、一番最近に出現した要素を表示する。

3. **スクロール検知**:
   - スクロールイベントを監視し、ビューポート内の最上位にある`h1`～`h6`を動的に判断する。
   - ビューポート内の他の見出しに基づいて固定表示を更新する。

4. **JavaScriptによる動的処理**:
   - JavaScriptを用いて、スクロールに応じて見出しの位置を動的に制御。
   - jQueryのようなライブラリを使用しても良いが、ネイティブのJavaScriptでも可能。

5. **レスポンシブデザイン**:
   - 異なるデバイスや画面サイズでもうまく機能するようにレスポンシブデザインを考慮する。

6. **パフォーマンス最適化**:
   - スクロールのパフォーマンスを最適化するために、必要に応じてデバウンスやスロットリングを実装。

7. **アクセシビリティ**:
   - 固定された見出しがスクリーンリーダーなどのアクセシビリティ機能に影響を与えないように考慮。

この要件を踏まえて、HTMLとCSS、JavaScriptを組み合わせて実装することができます。JavaScriptでスクロールイベントをキャプチャし、特定の要素を固定表示するように制御します。
</answer>

<feedback>
ありがとうございます！かなりいい感じです。さて、追加の要件です。

- スティッキーされる見出し空間の最大表示縦幅の行数をユーザーによってカスタマイズできるようにしてください。初期値は5行文でお願いします。
  - 最大表示縦幅 (行数分) を決めることで見切れてしまう部分には、スティッキーされる見出し空間自体にスクロール機能を設けることで参照できるようにしてください
- スティッキーされる見出し空間にある各見出しをクリックするとその見出しにジャンプできるようにしてください
</feedback>

<feedback>
追加の修正点です。解消してください。

- 拡張のポップアップ横幅が狭すぎます。もっとゆとりを持たせてください
- 最大表示行数の入力フィールドはnumberのinput要素にしてください。シークバーは操作に適していません。
- ページ内ジャンプが機能していません。スティッキー空間の見出しをクリックしても何も起きません
</feedback>

<feedback>
追加の修正をお願いします。

- スティッキーな見出し空間の、見出しのリンクのページ内ジャンプが効いていません
  - 要求としてはその見出しの位置にURLフラグメントを用いてページリロードさせる、またはid要素を直接読み込んでそこにJavaScriptとAPIを使って強制的にスクロールさせることなどです。手段はお任せします
- スティッキーな見出し空間の中でのスクロールが効きません
  - あくまで要求としては、表示行数がカスタマイズできても見出し空間の中を直接スクロールすると見切れた見出しが見れること、が期待値です。情報量を削らないでください
</feedback>

<feedback>
追加の修正依頼です。

- この機能が提供する見出し空間の中の見出しリンククリックでページ内ジャンプを実現するため、見出し要素に対して scrollIntoView を使ってください
- URLパターンは複数登録できるようにしてください。テキストファイルなどから直接貼り付けられることを想定してください
</feedback>

<feedback>
ページ内ジャンプは何度やっても実現できないので、もういいです。
別で、URLパターンは機能していないようです。何も登録していないのにどのページでも動作してしまっています。
</feedback>

<feedback>
実行してみるととんでもない挙動に気が付きました。毎フレームごとにスティッキー空間のdiv要素を再生成し直しているようです。これではかなりエネルギー効率が悪いです。必要なときにだけスティッキー空間を再生成するよう、コードを修正してください。
</feedback>

<feedback>
アプリを確認したところ、スクロールしても全然反映されなくなってしまいました。効率的に動いてかつ、なるべくユーザーの操作に追従しながらスティッキー空間を再生成し直すよう、コードを書き換えてください
</feedback>

<feedback>
改善はされたけど、もっと吸い付くように動いてほしいかも。
更新間隔を時間基準で扱うんじゃなくて、ユーザーの操作イベントを基準に滑らかな反映を可能にできませんか？
</feedback>
